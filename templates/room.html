<!doctype html>
<html lang="en">
<head>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="/static/style.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" crossorigin="anonymous">

    <title>Dialogue Den</title>
</head>
<body>

<h1>{{room_data.name}}</h1>
<input id="chat_id" type="hidden" value="{{room_data.id}}"/>
<input id="user_id" type="hidden" value="{{room_data.current_user_id}}"/>
<input id="user_name" type="hidden" value="{{room_data.current_user}}"/>


<div class="row">
    <div class="col-5">
        Logged users:
            <div id="current_users">
                <div class="logged_user" id="{{room_data.current_user_id}}"><b> <i>(you)</i> {{room_data.current_user}}</b>
                    <button id="leave_room" class="btn btn-danger btn-sm float-right">Leave room</button></div>
                {% for item in room_data.existing_users %}
                <div class="logged_user" id="{{item[1]}}"><b>{{item[0]}}</b></div>
                {% endfor %}
            </div>
        <div class="task">
            <div class="task_description">
                Collaborate to play the game
            </div>
            <div class='cards_list'>
                {% for card in room_data.game%}
                {% set attr = 'checked' if card['checked'] == 'True' else '' %}
                <div class='card_container'>
                    <div class='card'>{{card['value']}}</div>
                        {% if card['checked'] %}
                            <input type="checkbox" checked id='{{card["value"]}}' value={{card["value"]}}>
                        {% else %}
                            <input type="checkbox" id='{{card["value"]}}' value={{card["value"]}}>
                        {% endif %}
                </div>
                {% endfor %}
            </div>
            <button type="button" id="btn-agree" class="btn btn-success">Agree</button>
            <button type="button" id="btn-disagree" class="btn btn-danger">Disagree</button>

        </div>
    </div>
    <div class="col-7">
        <div class="chatbox">
            {% for item in room_data.messages %}
            <div class="message msg-other"><b>{{item['user_name']}}: </b>{{item['message']}}</div>
            {%endfor%}
        </div>
        <form class="sumbission" action="" method="POST">
            <input type="text" id="message" placeholder="Type a message"/>
            <input class="btn btn-primary" type="submit"/>
        </form>
    </div>
</div>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>


</html>
<script type="text/javascript">
$(function() {
    function boldMentions(str){
        var regex = new RegExp("@\\w*", 'gi');
        str = str.replace(regex, function(str) {return '<b>'+str+'</b>'})
        return str;
    }

    $('div.chatbox').scrollTop($('div.chatbox')[0].scrollHeight);

    var logged_users = [
        {'label': "@all",'id':'1'},
    ];
    {% for user in room_data.existing_users%}
        logged_users.push({'label': "@" + "{{user[0]}}", 'id': "{{user[1]}}"})
    {%endfor%}

    function split(val){
      return val.split( / \s*/ );
    }

    function extractLast(term) {
      return split(term).pop();
    }

    function get_card_selection(){
        let selection = []
        $("input:checkbox").each(function(){
            selection.push({'value': $(this).val(), 'checked': $(this).is(":checked")});
        });

        return selection;
    }

    var autocomplete_options = {
        minLength: 1,
        position: { my : "right bottom", at: "right top" },
        autoFocus: true,
        source: function( request, response ) {
            // delegate back to autocomplete, but extract the last term
            var lastword = extractLast(request.term);
            if (lastword.length == 0){
                return;
            }
            // Regexp for filtering those labels that start with '@'
            var matcher = new RegExp( "^" + $.ui.autocomplete.escapeRegex(lastword) + '+', "i" );
            // Get all labels
            var labels = logged_users.map(function(item){return item.label;});
            var results = $.grep(labels, function( item ){
                             return matcher.test(item);
                        });
            response( $.ui.autocomplete.filter(results, lastword) );
        },
        focus: function() {
          // prevent value inserted on focus
          return false;
        },
        select: function( event, ui ) {
          var terms = split( this.value );
          // remove the current input
          terms.pop();
          // add the selected item
          terms.push( ui.item.value );
          // add placeholder to get the comma-and-space at the end
          terms.push("");
          this.value = terms.join(" ");
          return false;
        }
      }

    var socket = io.connect('http://' + document.domain + ':' + location.port, { transports: ['websocket'] });
    var room_id = $('input#chat_id').val();
    existing = $('#current_users').text();


    socket.on( 'connect', function() {
        user_name = $("#user_name").val();
        socket.emit('join', { 'room': room_id, 'user_name': user_name});
        $('.logged_user').removeClass('wason-agreed');

    });

    $('#leave_room').on('click', function(e){
        var user_name = $('input#user_name').val();
        var user_id = $('input#user_id').val();
        socket.emit('leave', { user_name: user_name, room: room_id, user_id:user_id});
        window.location.replace("/");
    });

    $('form').on('submit', function(e) {
        var user_name = $('input#user_name').val();
        var user_id = $('input#user_id').val();
        e.preventDefault();
        let message = $('input#message').val();
        if (message!=""){
            socket.emit( 'response', {
                user_id: user_id,
                user_name: user_name,
                type: 'CHAT_MESSAGE',
                message: message,
                room: room_id
          });
        }
        $('input#message').val('').focus();
      });


    var card_click = $('input:checkbox').on('change', function(e){
        var selection = get_card_selection();
        var user_name = $('input#user_name').val();
        var user_id = $('input#user_id').val();
        socket.emit( 'response', {
            user_id: user_id,
            user_name: user_name,
            type: 'WASON_GAME',
            message: selection,
            room: room_id
        });
    });


    var agree_clicked = $('#btn-agree').on('click', function(e){
        var selection = get_card_selection();
        var user_name = $('input#user_name').val();
        var user_id = $('input#user_id').val();
        socket.emit('response', {
            user_id: user_id,
            user_name: user_name,
            type: 'AGREE_WASON_GAME',
            message: selection,
            room: room_id
        });
        $('#btn-agree').prop('disabled', true);
        $('#btn-disagree').prop('disabled', false);

    });

    var disagree_clicked = $('#btn-disagree').on('click', function(e){
        var selection = get_card_selection();
        var user_name = $('input#user_name').val();
        var user_id = $('input#user_id').val();
        socket.emit('response', {
            user_id: user_id,
            user_name: user_name,
            type: 'DISAGREE_WASON_GAME',
            message: selection,
            room: room_id
        });
        $('#btn-disagree').prop('disabled', true);
        $('#btn-agree').prop('disabled', false);
    });

    socket.on('response', function(message_str) {
        msg =  JSON.parse(message_str);

        switch(msg.type) {
            case 'CHAT_MESSAGE':
                if(typeof msg.user_name !== 'undefined' ) {
                        var user_name = $('input#user_name').val();
                        var user_id = $('input#user_id').val();
                        local_name = msg.user_name
                        local_id = msg.user_id

                        processed_message = boldMentions(msg.message);
                        console.log(processed_message);
                        if (local_id == user_id){
                            $( 'div.chatbox' ).append('<div class="message msg-mine"><b>' + local_name +': </b> ' + processed_message +'</div>' )
                        }else{
                            $( 'div.chatbox' ).append('<div class="message msg-other"><b>' + local_name +': </b> ' + processed_message + '</div>' )
                        }
                        $('div.chatbox').scrollTop($('div.chatbox')[0].scrollHeight);
                    }
                break;
            case 'WASON_GAME':
                $.each( msg.message, function( key, value ) {
                    $('input:checkbox#' + value['value']).prop('checked', value['checked']);
                });
                $('.logged_user').removeClass('wason-agreed');
                $('#btn-agree').prop('disabled', false);
                break;
            case 'AGREE_WASON_GAME':
                target_user_id = msg.user_id;
                $('#' + target_user_id).removeClass('wason-disagreed');
                $('#' + target_user_id).addClass('wason-agreed');
                break;
            case 'DISAGREE_WASON_GAME':
                target_user_id = msg.user_id;
                $('#' + target_user_id).removeClass('wason-agreed');
                $('#' + target_user_id).addClass('wason-disagreed');
                break;
            case 'JOIN_ROOM':
                $("#current_users").append("<div class='logged_user' id='" + msg.user_id + "'><b>" + msg.user_name + "</b></div>");
                logged_users.push({'label': "@" + msg.user_name,'id': msg.user_id})
                $("#message").bind("keydown", function(event){
                    if (event.keyCode === $.ui.keyCode.TAB &&
                        $(this).autocomplete("instance").menu.active ) {
                      event.preventDefault();
                    }
                  }).autocomplete(autocomplete_options);
                break;
            case 'LEAVE_ROOM':
                console.log("Leaving: " + msg.user_name);
                logged_users= logged_users.filter(function(el) { return el.label != "@"+msg.user_name; });
                $("#message").bind("keydown", function( event ) {
                    if (event.keyCode === $.ui.keyCode.TAB &&
                        $(this).autocomplete("instance").menu.active ) {
                      event.preventDefault();
                    }
                }).autocomplete(autocomplete_options);
                break;
            default:
            // code block
        }
    });



    $("#message").bind("keydown", function( event ) {
        if (event.keyCode === $.ui.keyCode.TAB &&
            $(this).autocomplete("instance").menu.active ) {
          event.preventDefault();
        }
      }).autocomplete(autocomplete_options);


    $(window).on('mouseover', (function () {
        window.onbeforeunload = null;
    }));
    $(window).on('mouseout', (function () {
        window.onbeforeunload = Leave;
    }));
    function Leave() {
        var user_name = $('input#user_name').val();
        var user_id = $('input#user_id').val();
        socket.emit('leave', { user_name: user_name, room: room_id, user_id:user_id});
    }
    var prevKey="";
    $(document).keydown(function (e) {
        if (e.key=="F5") {
            window.onbeforeunload = Leave;
        }
        else if (e.key.toUpperCase() == "W" && prevKey == "CONTROL") {
            window.onbeforeunload = Leave;
        }
        else if (e.key.toUpperCase() == "R" && prevKey == "CONTROL") {
            window.onbeforeunload = Leave;
        }
        else if (e.key.toUpperCase() == "F4" && (prevKey == "ALT" || prevKey == "CONTROL")) {
            window.onbeforeunload = Leave;
        }
        prevKey = e.key.toUpperCase();
    });
});

</script>

