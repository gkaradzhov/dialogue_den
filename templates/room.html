<!doctype html>
<html lang="en">
<head>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="/static/style.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" crossorigin="anonymous">

    <title>Dialogue Den</title>
</head>
<body>
<input id="chat_id" type="hidden" value="{{room_data.id}}"/>
<input id="user_id" type="hidden" value="{{room_data.current_user_id}}"/>
<input id="user_name" type="hidden" value="{{room_data.current_user}}"/>
<input id="user_status" type="hidden" value="{{room_data.current_user_status}}"/>

<div id="result_holder"></div>
<div class="timer_holder hidden"> Please complete the task within the next: <div id="timer"></div></div>

<div class="row">
    <div class="col-5">
        <div class="task">
            <h3>Task: </h3>
            <div class="task_description">
                You are presented with four cards. Each card has a letter on one side and a number on the other.
                <b> Which card(s) must you turn to test the rule: <br/>
                All cards with vowels on one side have an even number on the other.</b>
                To successfully finish the game you all have to agree on the final answer by pressing the <b>Submit</b> button.
            </div>
            <div class="play_prompt hidden">Thank you! Now you have to <b>collaborate</b> with the other participants in this conversation to solve the task together.</div>
            <div class='cards_list'>
                {% for card in room_data.game%}
                {% set attr = 'checked' if card['checked'] == 'True' else '' %}
                <div class='card_container'>
                    <div class='card'>{{card['value']}}</div>
                        {% if card['checked'] %}
                            <input type="checkbox" checked id='{{card["value"]}}' value={{card["value"]}}>
                        {% else %}
                            <input type="checkbox" id='{{card["value"]}}' value={{card["value"]}}>
                        {% endif %}
                </div>
                {% endfor %}
            </div>
            <div class="game_buttons">
                <button type="button" id="btn-agree" class="btn btn-success btn-lg">Submit</button>
            </div>
        </div>
        <hr/>
        <h3>Logged users:</h3>
            <div id="current_users">
                <div class="logged_user" id="{{room_data.current_user_id}}"><b> <i>(you)</i> {{room_data.current_user}}</b>
                    <button id="leave_room" class="btn btn-danger btn-sm float-right">Leave room</button></div>
                {% for item in room_data.existing_users %}
                <div class="logged_user" id="{{item[1]}}"><b>{{item[0]}}</b></div>
                {% endfor %}
            </div>
    </div>
    <div id="chat_container" class="col-7 hidden">
        <div class="chatbox">
            {% for item in room_data.messages %}
            <div class="message msg-other"><b>{{item.origin}}: </b>{{item.content}}</div>
            {%endfor%}
        </div>
        <form class="sumbission" action="" method="POST">
            <input type="text" id="message" placeholder="Type a message"/>
            <input class="btn btn-primary" type="submit"/>
            <div class="note">TIP: You can @mention the other participants.</div>
        </form>
    </div>
</div>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>


</html>
<script type="text/javascript">

const JOIN_ROOM = 'JOIN_ROOM';
const CHAT_MESSAGE = 'CHAT_MESSAGE';
const LEAVE_ROOM = 'LEAVE_ROOM';
const FINISHED_ONBOARDING = 'FINISHED_ONBOARDING';
const WASON_INITIAL = 'WASON_INITIAL';
const WASON_GAME = 'WASON_GAME';
const WASON_AGREE = 'WASON_SUBMIT';
const WASON_FINISHED = 'WASON_FINISHED';

const USR_ONBOARDING = 'USR_ONBOARDING';
const USR_PLAYING = 'USR_PLAYING';
const USR_MODERATING = 'USR_MODERATING';

$(function() {
    function boldMentions(str){
        var regex = new RegExp("@\\w*", 'gi');
        str = str.replace(regex, function(str) {return '<b>'+str+'</b>'})
        return str;
    }

    $('div.chatbox').scrollTop($('div.chatbox')[0].scrollHeight);

    var logged_users = [
        {'label': "@all",'id':'1'},
    ];
    {% for user in room_data.existing_users%}
        logged_users.push({'label': "@" + "{{user[0]}}", 'id': "{{user[1]}}"})
    {%endfor%}

    function split(val){
      return val.split( / \s*/ );
    }

    function extractLast(term) {
      return split(term).pop();
    }

    function get_card_selection(){
        let selection = []
        $("input:checkbox").each(function(){
            selection.push({'value': $(this).val(), 'checked': $(this).is(":checked")});
        });

        return selection;
    }

    var autocomplete_options = {
        minLength: 1,
        position: { my : "right bottom", at: "right top" },
        autoFocus: true,
        source: function( request, response ) {
            // delegate back to autocomplete, but extract the last term
            var lastword = extractLast(request.term);
            if (lastword.length == 0){
                return;
            }
            // Regexp for filtering those labels that start with '@'
            var matcher = new RegExp( "^" + $.ui.autocomplete.escapeRegex(lastword) + '+', "i" );
            // Get all labels
            var labels = logged_users.map(function(item){return item.label;});
            var results = $.grep(labels, function( item ){
                             return matcher.test(item);
                        });
            response( $.ui.autocomplete.filter(results, lastword) );
        },
        focus: function() {
          // prevent value inserted on focus
          return false;
        },
        select: function( event, ui ) {
          var terms = split( this.value );
          // remove the current input
          terms.pop();
          // add the selected item
          terms.push( ui.item.value );
          // add placeholder to get the comma-and-space at the end
          terms.push("");
          this.value = terms.join(" ");
          return false;
        }
      }

    var socket = io.connect('http://' + document.domain + ':' + location.port, { transports: ['websocket'] });
    var room_id = $('input#chat_id').val();
    existing = $('#current_users').text();


    socket.on( 'connect', function() {
        user_name = $("#user_name").val();
        var user_status = $('input#user_status').val();
        socket.emit('join', { 'room': room_id, 'user_name': user_name, 'user_status': user_status});
        $('.logged_user').removeClass('wason-agreed');
    });

    $('#leave_room').on('click', function(e){
        var user_name = $('input#user_name').val();
        var user_id = $('input#user_id').val();
        var user_status = $('input#user_status').val();
        socket.emit('leave', { user_name: user_name, room: room_id, user_id:user_id, user_status: user_status});
        window.location.href = "/";
    });

    var user_status = $('input#user_status').val()

    if (user_status == USR_MODERATING){
        $('#chat_container').removeClass('hidden');
        $('.play_prompt').removeClass('hidden');
    }

    $('form').on('submit', function(e) {
        var user_name = $('input#user_name').val();
        var user_id = $('input#user_id').val();
        var user_status = $('input#user_status').val()
        e.preventDefault();
        let message = $('input#message').val();
        if (message!=""){
            socket.emit( 'response', {
                user_id: user_id,
                user_name: user_name,
                type: CHAT_MESSAGE,
                message: message,
                room: room_id,
                user_status: user_status
          });
        }
        $('input#message').val('').focus();
      });


    var card_click = $('input:checkbox').on('change', function(e){
        var selection = get_card_selection();
        var user_name = $('input#user_name').val();
        var user_id = $('input#user_id').val();
        var user_status = $('input#user_status').val()
        socket.emit( 'response', {
            user_id: user_id,
            user_name: user_name,
            type: WASON_GAME,
            message: selection,
            user_status: user_status,
            room: room_id
        });

        $('#btn-agree').prop('disabled', false);
    });


    var agree_clicked = $('#btn-agree').on('click', function(e){
        var selection = get_card_selection();
        var user_name = $('input#user_name').val();
        var user_id = $('input#user_id').val();
        var user_status = $('input#user_status').val()

        socket.emit('response', {
            user_id: user_id,
            user_name: user_name,
            type: WASON_AGREE,
            message: selection,
            room: room_id,
            user_status: user_status
        });

        if (user_status == USR_ONBOARDING){
                $('input#user_status').val(USR_PLAYING);
                $('#chat_container').toggle();
                $('.play_prompt').toggle();
        }
        else{
            $('#btn-agree').prop('disabled', true);
        }
    });

    socket.on('response', function(message_str) {
        msg =  JSON.parse(message_str);

        switch(msg.type) {
            case CHAT_MESSAGE:
                if(typeof msg.user_name !== 'undefined' ) {
                        var user_name = $('input#user_name').val();
                        var user_id = $('input#user_id').val();
                        local_name = msg.user_name
                        local_id = msg.user_id

                        processed_message = boldMentions(msg.message);
                        console.log(processed_message);
                        if (local_id == user_id){
                            $( 'div.chatbox' ).append('<div class="message msg-mine"><b>' + local_name +': </b> ' + processed_message +'</div>' )
                        }else{
                            $( 'div.chatbox' ).append('<div class="message msg-other"><b>' + local_name +': </b> ' + processed_message + '</div>' )
                        }
                        $('div.chatbox').scrollTop($('div.chatbox')[0].scrollHeight);
                    }
                break;
            case JOIN_ROOM:
                $("#current_users").append("<div class='logged_user' id='" + msg.user_id + "'><b>" + msg.user_name + "</b></div>");
                logged_users.push({'label': "@" + msg.user_name,'id': msg.user_id})
                $("#message").bind("keydown", function(event){
                    if (event.keyCode === $.ui.keyCode.TAB &&
                        $(this).autocomplete("instance").menu.active ) {
                      event.preventDefault();
                    }
                  }).autocomplete(autocomplete_options);
                break;
            case LEAVE_ROOM:
                $('#'+msg.user_id).remove();
                logged_users= logged_users.filter(function(el) { return el.label != "@"+msg.user_name; });
                $("#message").bind("keydown", function( event ) {
                    if (event.keyCode === $.ui.keyCode.TAB &&
                        $(this).autocomplete("instance").menu.active ) {
                      event.preventDefault();
                    }
                }).autocomplete(autocomplete_options);
                break;
            case WASON_FINISHED:
                $('button').prop('disabled', true);
                $('input').prop('disabled', true);
                var user_name = $('input#user_name').val();
                var user_id = $('input#user_id').val();
                var user_status = $('input#user_status').val()
                $('#result_holder').append("<h1 class='finish'>Game Finished! Thank you for playing</h1>")
                $('.timer_holder').toggle();
                socket.emit('leave', { user_name: user_name, room: room_id, user_id:user_id, user_status: user_status});
                break;
            case WASON_AGREE:
                target_user_id = msg.user_id;
                if (msg.user_status == USR_PLAYING){
                    $('#' + target_user_id).addClass('wason-agreed');
                }
                break
            case FINISHED_ONBOARDING:
                $('.timer_holder').toggle();
                var date = msg.message;
                var countDownDate = new Date(date).getTime();

                var x = setInterval(function() {
                    var now = new Date().getTime();

                    // Find the distance between now and the count down date
                    var distance = countDownDate - now;

                    // Time calculations for days, hours, minutes and seconds

                    var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    var seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    $('#timer').text(minutes + " minutes " + seconds + " seconds");

                    // If the count down is finished, write some text
                    if (distance < 0) {
                        clearInterval(x);
                        $('#timer').text("Out of time");
                        var selection = get_card_selection();
                        var user_name = $('input#user_name').val();
                        var user_id = $('input#user_id').val();
                        var user_status = $('input#user_status').val()
                        socket.emit('response', {
                            user_id: user_id,
                            user_name: user_name,
                            type: 'OUT_OF_TIME',
                            message: selection,
                            room: room_id,
                            user_status: user_status
                        });
                    }
                }, 1000);
                break
            default:
                break
            // code block
        }
    });


    $("#message").bind("keydown", function( event ) {
        if (event.keyCode === $.ui.keyCode.TAB &&
            $(this).autocomplete("instance").menu.active ) {
          event.preventDefault();
        }
      }).autocomplete(autocomplete_options);


    $(window).on('mouseover', (function () {
        window.onbeforeunload = null;
    }));
    $(window).on('mouseout', (function () {
        window.onbeforeunload = Leave;
    }));
    function Leave() {
        var user_name = $('input#user_name').val();
        var user_id = $('input#user_id').val();
        var user_status = $('input#user_status').val()

        socket.emit('leave', { user_name: user_name, room: room_id, user_id:user_id, user_status: user_status});
    }
    var prevKey="";
    $(document).keydown(function (e) {
        if (e.key=="F5") {
            window.onbeforeunload = Leave;
        }
        else if (e.key.toUpperCase() == "W" && prevKey == "CONTROL") {
            window.onbeforeunload = Leave;
        }
        else if (e.key.toUpperCase() == "R" && prevKey == "CONTROL") {
            window.onbeforeunload = Leave;
        }
        else if (e.key.toUpperCase() == "F4" && (prevKey == "ALT" || prevKey == "CONTROL")) {
            window.onbeforeunload = Leave;
        }
        prevKey = e.key.toUpperCase();
    });
});

</script>

